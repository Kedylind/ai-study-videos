{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Upload Paper - KyleAI</title>
    <link rel="stylesheet" href="{% static 'web/css/upload.css' %}?v=2024.11.26">
</head>
<body>
    <!-- Background Orbs -->
    <div class="upload-background">
        <div class="gradient-orb orb-1"></div>
        <div class="gradient-orb orb-2"></div>
        <div class="gradient-orb orb-3"></div>
    </div>

    <!-- DNA Loading Animation (shared with base) -->
    <div id="loading-screen" class="loading-container" style="display: none;">
        <div class="dna-strand">
            <div class="dna-dot"></div>
            <div class="dna-dot"></div>
            <div class="dna-dot"></div>
            <div class="dna-dot"></div>
            <div class="dna-dot"></div>
            <div class="dna-dot"></div>
            <div class="dna-dot"></div>
            <div class="dna-dot"></div>
            <div class="dna-dot"></div>
            <div class="dna-dot"></div>
        </div>
        <div class="loading-text">Generating...</div>
    </div>

    <!-- Fixed Header -->
    <header class="site-header">
        <div class="header-container">
            <h1 class="header-logo">
                <a href="/" class="header-logo-link">KyleAI</a>
            </h1>
            <nav class="header-nav">
                {% if user.is_authenticated %}
                    <span class="nav-welcome">Welcome, <strong>{{ user.username }}</strong></span>
                    <a href="/my-videos/" class="nav-link">My Videos</a>
                    <a href="/upload/" class="nav-link">Upload Paper</a>
                    <form method="post" action="{% url 'logout' %}" class="nav-form">
                        {% csrf_token %}
                        <button type="submit" class="nav-button">Logout</button>
                    </form>
                {% else %}
                    <a href="{% url 'login' %}" class="nav-link">Login</a>
                    <a href="{% url 'register' %}" class="nav-link nav-link-primary">Register</a>
                {% endif %}
            </nav>
        </div>
    </header>

    <div class="upload-wrapper">
        <!-- Main Content -->
        <main>
            <div class="upload-container">
                <!-- Header -->
                <div class="upload-header">
                    <h2>Transform Your Research</h2>
                    <p>Upload a research paper and let AI create an engaging video summary for you in seconds.</p>
                </div>

                <!-- Messages -->
                {% if messages %}
                    {% for message in messages %}
                        <div class="alert {% if message.tags %}alert-{{ message.tags }}{% else %}alert-info{% endif %}">
                            {{ message }}
                        </div>
                    {% endfor %}
                {% endif %}

                <!-- Form -->
                <form method="post" autocomplete="off" data-form-type="other">
                    {% csrf_token %}
                    
                    <!-- Hidden dummy fields to trick password managers -->
                    <input type="text" name="fake_username" autocomplete="username" style="position: absolute; left: -9999px; opacity: 0; pointer-events: none;" tabindex="-1" aria-hidden="true">
                    <input type="password" name="fake_password" autocomplete="current-password" style="position: absolute; left: -9999px; opacity: 0; pointer-events: none;" tabindex="-1" aria-hidden="true">

                    <!-- PubMed ID Input -->
                    <div class="form-group">
                        <label for="{{ form.paper_id.id_for_label }}">{{ form.paper_id.label }}</label>
                        {{ form.paper_id }}
                        {% if form.paper_id.help_text %}
                            <p class="help-text">{{ form.paper_id.help_text|safe }}</p>
                        {% endif %}
                        {% if form.paper_id.errors %}
                            <div class="alert alert-error">
                                {% for error in form.paper_id.errors %}
                                    {{ error }}
                                {% endfor %}
                            </div>
                        {% endif %}
                    </div>

                    <!-- Access Code Input -->
                    <div class="form-group">
                        <label for="{{ form.access_code.id_for_label }}">{{ form.access_code.label }}</label>
                        <div style="position: relative;">
                            {{ form.access_code }}
                        </div>
                        {% if form.access_code.help_text %}
                            <p class="help-text">{{ form.access_code.help_text|safe }}</p>
                        {% endif %}
                        {% if form.access_code.errors %}
                            <div class="alert alert-error">
                                {% for error in form.access_code.errors %}
                                    {{ error }}
                                {% endfor %}
                            </div>
                        {% endif %}
                        {% if form.non_field_errors %}
                            <div class="alert alert-error">
                                {% for error in form.non_field_errors %}
                                    {{ error }}
                                {% endfor %}
                            </div>
                        {% endif %}
                    </div>

                    <!-- Buttons -->
                    <div class="button-group">
                        <button type="submit" class="btn btn-primary">Generate Video</button>
                        <a href="/" class="btn btn-secondary">Cancel</a>
                    </div>
                </form>

                <!-- Info Box -->
                <div style="margin-top: 40px; padding: 20px; background: rgba(232, 240, 247, 0.5); border-radius: 12px; border-left: 4px solid #4a7ba7;">
                    <p style="color: #1e3a5f; font-size: 14px; line-height: 1.6; margin: 0;">
                        <strong>ðŸ’¡ Tip:</strong> Enter a PubMed ID (e.g., 12345678) or PMCID (e.g., PMC10979640) to automatically fetch the paper and generate an AI powered video of your research.
                    </p>
                </div>
            </div>
        </main>
    </div>

    <!-- Scripts -->
    <script src="{% static 'web/js/upload.js' %}"></script>
    <script>
        // Aggressively prevent password manager autofill on upload form
        document.addEventListener('DOMContentLoaded', function() {
            // Get all input fields in the upload form
            const form = document.querySelector('form[method="post"][enctype="multipart/form-data"]');
            if (form) {
                const inputs = form.querySelectorAll('input[type="text"], input[type="password"]');
                
                inputs.forEach(function(input) {
                    // Force autocomplete attributes immediately
                    if (input.type === 'password') {
                        input.setAttribute('autocomplete', 'one-time-code');
                    } else {
                        input.setAttribute('autocomplete', 'off');
                    }
                    
                    // Remove readonly on any interaction
                    const removeReadonly = function() {
                        input.removeAttribute('readonly');
                    };
                    input.addEventListener('focus', removeReadonly);
                    input.addEventListener('click', removeReadonly);
                    input.addEventListener('keydown', removeReadonly);
                    input.addEventListener('touchstart', removeReadonly);
                    
                    // Track if user has interacted
                    let userInteracted = false;
                    input.addEventListener('keypress', function() {
                        userInteracted = true;
                    });
                    input.addEventListener('input', function() {
                        userInteracted = true;
                    });
                    
                    // Monitor for autofill and clear it if detected
                    let lastValue = input.value;
                    const checkAutofill = setInterval(function() {
                        if (input.value !== lastValue && !userInteracted) {
                            // Value changed but user didn't type - likely autofill
                            if (input.type === 'password' && input.value.length > 0) {
                                // Clear autofilled password
                                input.value = '';
                                input.focus();
                                // Re-apply prevention
                                input.setAttribute('autocomplete', 'one-time-code');
                                input.setAttribute('readonly', 'readonly');
                            }
                        }
                        lastValue = input.value;
                    }, 100);
                    
                    // Stop monitoring after 5 seconds
                    setTimeout(function() {
                        clearInterval(checkAutofill);
                    }, 5000);
                    
                    // Additional prevention: periodically re-apply attributes
                    setInterval(function() {
                        if (input.type === 'password') {
                            input.setAttribute('autocomplete', 'one-time-code');
                        }
                    }, 1000);
                });
                
                // Prevent form autofill
                form.setAttribute('autocomplete', 'off');
                form.setAttribute('data-form-type', 'other');
            }
            
            // Show loading screen on form submission
            const forms = document.querySelectorAll('form');
            forms.forEach(form => {
                form.addEventListener('submit', function() {
                    if (this.method.toUpperCase() !== 'POST' || this.action.includes('logout')) {
                        return;
                    }
                    document.getElementById('loading-screen').style.display = 'flex';
                });
            });
        });
    </script>
</body>
</html>
