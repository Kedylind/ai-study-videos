{% extends "base.html" %}

{% block title %}Pipeline Status - {{ pmid }} - KyleAI{% endblock %}

{% block content %}
  <h1>Pipeline Status</h1>
  <p>Tracking the generation process for paper <strong id="pmid-display">{{ pmid }}</strong>.</p>

  <!-- Status Alert Container (will be updated by JavaScript) -->
  <div id="status-alert-container">
    {% if final_video_exists %}
      <div class="alert alert-info">
        <p><strong>Final video ready!</strong></p>
        <div class="button-group">
          <a href="{{ final_video_url }}" class="btn-primary">Download/Play</a>
          <a href="/result/{{ pmid }}" class="btn-secondary">Open result page</a>
        </div>
      </div>
    {% elif progress.status == "failed" %}
      <div class="alert alert-error">
        <p><strong>‚ùå Video generation failed</strong></p>
        {% if error_message %}
          <p>{{ error_message }}</p>
        {% elif progress.error %}
          <p>{{ progress.error }}</p>
        {% elif progress.error_type %}
          <p>An error occurred: {{ progress.error_type }}</p>
        {% else %}
          <p>An error occurred during video generation. Please check the log below for details.</p>
        {% endif %}
      </div>
    {% else %}
      <div class="alert alert-info">
        <p>Pipeline is running. Status will update automatically...</p>
      </div>
    {% endif %}
  </div>

  <!-- Video Download Section (shown when video exists) -->
  {% if final_video_exists %}
  <div data-video-section class="video-ready-section">
    <h2>üé¨ Video Ready!</h2>
    <p>Your video has been successfully generated and is ready to download or play.</p>
    <div class="button-group">
      <a href="{{ final_video_url }}" class="btn-primary">‚ñ∂Ô∏è Play/Download Video</a>
      <a href="/result/{{ pmid }}" class="btn-secondary">üìÑ View Result Page</a>
    </div>
  </div>
  {% elif progress.progress_percent >= 100 %}
  <!-- Video Section - Fallback that shows when progress is 100% but video not detected yet -->
  <div id="video-section-fallback" data-video-section class="video-ready-section">
    <h2>üé¨ Video Ready!</h2>
    <p>Your video has been successfully generated.</p>
    {% if final_video_url %}
    <div class="button-group">
      <a href="{{ final_video_url }}" class="btn-primary">‚ñ∂Ô∏è Play/Download Video</a>
      <a href="/result/{{ pmid }}" class="btn-secondary">üìÑ View Result Page</a>
    </div>
    {% else %}
    <p class="video-processing">Video file is being processed. Please refresh the page in a moment.</p>
    <a href="/result/{{ pmid }}" class="btn-secondary">Try Result Page</a>
    {% endif %}
  </div>
  {% endif %}

  <!-- Progress Information -->
  <h2>Progress</h2>
  <div id="progress-container" class="progress-container">
    <div class="progress-bar-container">
      <div id="progress-bar" class="progress-bar" style="width: {{ progress.progress_percent }}%;"></div>
    </div>
    <p><strong id="progress-text">{{ progress.progress_percent }}%</strong> complete (<span id="completed-count">{{ progress.completed_steps|length }}</span> of <span id="total-steps">{{ progress.total_steps }}</span> steps)</p>
    
    {% if final_video_exists and progress.progress_percent >= 100 %}
    <div class="alert alert-info">
      <p><strong>‚úÖ All steps completed!</strong> Your video is ready. Use the download button above to access it.</p>
    </div>
    {% endif %}
    
    <div id="current-step-container">
      {% if progress.current_step %}
        <p><strong>Current step:</strong> <span id="current-step-text">{{ progress.current_step }}</span></p>
      {% else %}
        <p id="current-step-text" style="display: none;"><strong>Current step:</strong> <span></span></p>
      {% endif %}
    </div>
    
    <div id="completed-steps-container">
      {% if progress.completed_steps %}
        <p><strong>Completed steps:</strong></p>
        <ul id="completed-steps-list">
          {% for step in progress.completed_steps %}
            <li>‚úì {{ step }}</li>
          {% endfor %}
        </ul>
      {% else %}
        <ul id="completed-steps-list" style="display: none;"><strong>Completed steps:</strong></ul>
      {% endif %}
    </div>
  </div>

  <div class="button-group">
    <a href="/upload/" class="btn-primary">Generate another video</a>
    <a href="?_json=1" class="btn-secondary" target="_blank">View JSON status</a>
  </div>

  <script>
    // Auto-refresh status page
    const pmid = "{{ pmid }}";
    let refreshInterval = null;
    let isCompleted = {% if final_video_exists %}true{% else %}false{% endif %};
    let isFailed = {% if progress.status|default:"" == "failed" %}true{% else %}false{% endif %};
    let lastProgressTimestamp = null;
    let staleUpdateCount = 0;

    function updateStatus() {
      fetch(`/status/${pmid}/?_json=1`, {
        cache: 'no-store',  // Prevent browser caching
        headers: {
          'Cache-Control': 'no-cache',
          'Pragma': 'no-cache'
        }
      })
        .then(response => {
          // Check if response is from cache
          if (response.headers.get('X-From-Cache')) {
            console.warn('Response was cached, forcing refresh');
            return updateStatus();  // Retry
          }
          return response.json();
        })
        .then(data => {
          // Check if progress timestamp is newer
          if (data.progress_updated_at) {
            const updateTime = new Date(data.progress_updated_at);
            if (lastProgressTimestamp && updateTime <= lastProgressTimestamp) {
              staleUpdateCount++;
              if (staleUpdateCount > 5) {
                console.warn('Progress updates appear stale, last update:', lastProgressTimestamp);
                // Could show warning to user: "Progress updates may be delayed"
              }
            } else {
              staleUpdateCount = 0;
              lastProgressTimestamp = updateTime;
            }
          }
          
          // Update progress bar
          const progressBar = document.getElementById('progress-bar');
          const progressText = document.getElementById('progress-text');
          const completedCount = document.getElementById('completed-count');
          const totalSteps = document.getElementById('total-steps');
          
          if (progressBar && data.progress_percent !== undefined) {
            progressBar.style.width = data.progress_percent + '%';
            if (progressText) progressText.textContent = data.progress_percent + '%';
            if (completedCount) completedCount.textContent = data.completed_steps ? data.completed_steps.length : 0;
            if (totalSteps) totalSteps.textContent = data.total_steps || 5;
          }

          // Update current step
          const currentStepText = document.getElementById('current-step-text');
          if (currentStepText) {
            if (data.current_step) {
              currentStepText.style.display = 'block';
              const span = currentStepText.querySelector('span');
              if (span) span.textContent = data.current_step;
            } else {
              currentStepText.style.display = 'none';
            }
          }

          // Update completed steps
          const completedStepsList = document.getElementById('completed-steps-list');
          if (completedStepsList && data.completed_steps) {
            completedStepsList.innerHTML = '';
            data.completed_steps.forEach(step => {
              const li = document.createElement('li');
              li.textContent = '‚úì ' + step;
              completedStepsList.appendChild(li);
            });
            if (data.completed_steps.length > 0) {
              completedStepsList.parentElement.style.display = 'block';
            }
          }

          // Update status alert
          const statusContainer = document.getElementById('status-alert-container');
          if (statusContainer) {
            // Check if video exists - multiple conditions
            const videoReady = (
              (data.status === 'completed' && data.final_video_url) ||
              (data.progress_percent >= 100 && data.final_video_url) ||
              (data.final_video === true && data.final_video_url)
            );
            
            if (videoReady) {
              // Video is ready - show success message
              statusContainer.innerHTML = `
                <div class="video-ready-section">
                  <h2>üé¨ Video Ready!</h2>
                  <p>Your video has been successfully generated and is ready to download or play.</p>
                  <div class="button-group">
                    <a href="${data.final_video_url}" class="btn-primary">‚ñ∂Ô∏è Play/Download Video</a>
                    <a href="/result/${pmid}" class="btn-secondary">üìÑ View Result Page</a>
                  </div>
                </div>
              `;
              
              // Also show the static video section if it exists
              const videoSection = document.querySelector('[data-video-section]');
              if (videoSection) {
                videoSection.style.display = 'block';
              }
              
              isCompleted = true;
              stopPolling();
            } else if (data.status === 'failed') {
              const errorMsg = data.error_message || data.error || 'An error occurred during video generation.';
              statusContainer.innerHTML = `
                <div class="alert alert-error">
                  <p><strong>‚ùå Video generation failed</strong></p>
                  <p>${errorMsg}</p>
                </div>
              `;
              isFailed = true;
              stopPolling();
            } else if (data.status === 'running' || data.status === 'pending') {
              statusContainer.innerHTML = `
                <div class="alert alert-info">
                  <p>Pipeline is running. Status will update automatically...</p>
                </div>
              `;
            }
          }
        })
        .catch(error => {
          console.error('Error fetching status:', error);
        });
    }

    function startPolling() {
      if (isCompleted || isFailed) {
        return; // Don't poll if already completed or failed
      }
      
      // Poll every 3 seconds
      refreshInterval = setInterval(updateStatus, 3000);
    }

    function stopPolling() {
      if (refreshInterval) {
        clearInterval(refreshInterval);
        refreshInterval = null;
      }
    }

    // Start polling when page loads (if not already completed/failed)
    if (!isCompleted && !isFailed) {
      startPolling();
      // Also update immediately after a short delay
      setTimeout(updateStatus, 1000);
    }

    // Clean up on page unload
    window.addEventListener('beforeunload', stopPolling);
  </script>
{% endblock %}
