# File Upload Feature - Testing Guide

## Quick Start

### Prerequisites
```bash
# Install dependencies
pip install -r requirements.txt

# Apply migrations (if any)
python manage.py migrate

# Start Redis (for Celery)
redis-server

# Start Celery worker (in another terminal)
celery -A config worker -l info

# Start Django dev server (in another terminal)
python manage.py runserver
```

### Basic Test Scenario

#### Test 1: Upload a PDF File
1. Go to `http://localhost:8000/upload/`
2. Login with test user
3. Click "Upload file" button
4. Select any PDF file from your computer
5. Enter the access code (from `VIDEO_ACCESS_CODE` env var)
6. Click "Generate Video"
7. **Expected:**
   - File is saved to `media/<filename>/`
   - `paper.json` is created in the same directory
   - Redirect to status page
   - Pipeline status shows "pending" or "running"
   - First step is "generate-script" (not "fetch-paper")

#### Test 2: Upload a TXT File
1. Repeat Test 1 with a `.txt` file
2. **Expected:** Same behavior as PDF

#### Test 3: Test File Validation
1. Try uploading a file > 50MB
   - **Expected:** Error message "File is too large (max 50MB)"

2. Try uploading a `.docx` or `.zip` file
   - **Expected:** Error message "Unsupported file type. Supported: .pdf, .txt"

3. Try uploading an empty file
   - **Expected:** Error message "File is empty"

#### Test 4: Verify Paper JSON Content
1. After uploading a file, check the created `paper.json`:
   ```bash
   cat media/<filename>/paper.json | jq .
   ```
2. **Expected output structure:**
   ```json
   {
     "title": "filename-as-title",
     "abstract": "First 500 characters...",
     "full_text": "Complete extracted text...",
     "authors": ["Unknown"],
     "publication_date": "2025-11-25T...",
     "source": "local_file",
     "filename": "original-filename.pdf"
   }
   ```

#### Test 5: Verify Pipeline Skips fetch-paper
1. Upload a file and check status
2. Look at the status page or API response
3. **Expected:**
   - `completed_steps` should NOT include "fetch-paper" (OR)
   - `current_step` should be "generate-script" (not "fetch-paper")
   - Pipeline log should say "skipping fetch-paper step"

#### Test 6: Verify PubMed ID Still Works
1. Go to upload page and enter a valid PubMed ID (e.g., `33963468`)
2. Enter access code and submit
3. **Expected:**
   - File upload field is ignored
   - Pipeline DOES run fetch-paper step
   - Status shows "fetch-paper" as first completed step

### Command-Line Testing (No Web UI)

#### Test File Processing Directly
```python
from pathlib import Path
from web.file_utils import process_uploaded_file

# Test with a real PDF
pdf_path = Path("path/to/your/file.pdf")
output_dir = Path("test_output")
output_dir.mkdir(exist_ok=True)

success, error_msg, paper_data = process_uploaded_file(pdf_path, output_dir)

if success:
    print("✓ File processing successful!")
    print(f"  Title: {paper_data['title']}")
    print(f"  Text length: {len(paper_data['full_text'])} chars")
else:
    print(f"✗ Error: {error_msg}")
```

#### Test Pipeline with Local File
```bash
# Create output directory with extracted paper.json
mkdir -p test_video_output
cp test_output/paper.json test_video_output/

# Run pipeline (should skip fetch-paper)
python kyle-code/main.py generate-video test_file test_video_output/
```

### Checking Logs

#### Django/Web Logs
```bash
# Check for upload errors
grep -i "file" /var/log/django.log
grep -i "upload" /var/log/django.log
```

#### Pipeline Logs
```bash
# Check pipeline execution
cat media/<filename>/pipeline.log | tail -50
```

#### Celery Task Logs
```bash
# Watch Celery worker output for task execution
```

## Test Files You Can Use

### Create Test PDF
```python
from reportlab.lib.pagesizes import letter
from reportlab.pdfgen import canvas

# Create a simple test PDF
c = canvas.Canvas("test.pdf", pagesize=letter)
c.drawString(100, 750, "Test Paper")
c.drawString(100, 700, "This is a test PDF for file upload feature.")
c.showPage()
c.save()
```

### Create Test TXT File
```bash
cat > test.txt << 'EOF'
Test Paper Title

This is a test text file for the file upload feature.

It contains multiple paragraphs to simulate a real academic paper.

The system should extract all this text and create a paper.json file.

This demonstrates that the file upload feature is working correctly.
EOF
```

## Expected Files After Upload

```
media/
└── <filename>/
    ├── <original-filename>.pdf  (uploaded file)
    ├── paper.json              (created by extraction)
    ├── pipeline.log            (created by pipeline)
    ├── task_id.txt             (Celery task ID)
    ├── task_result.json        (task status)
    ├── script.json             (generated by pipeline)
    ├── audio.wav               (generated by pipeline)
    ├── audio_metadata.json     (generated by pipeline)
    ├── clips/                  (generated video clips)
    ├── clips_captioned/        (captioned clips)
    └── final_video.mp4         (final output)
```

## Debugging Tips

### If paper.json is not created
1. Check Django logs for file processing errors
2. Verify file exists in media directory
3. Check file type (.pdf or .txt)
4. Check file size (under 50MB)
5. Try with a simpler PDF (complex layouts may have issues)

### If pipeline doesn't skip fetch-paper
1. Verify paper.json exists in the output directory
2. Check main.py `generate_video()` function is detecting local files
3. Check pipeline logs for the "skipping fetch-paper" message

### If file extraction fails
1. Try with a different PDF (some PDFs have encrypted or image-only content)
2. Check that PyPDF2 is installed: `pip list | grep PyPDF2`
3. Look at the specific error in the form or logs

### If Celery task doesn't start
1. Verify Redis is running: `redis-cli ping`
2. Verify Celery worker is running
3. Check Celery logs for errors
4. Verify CELERY_BROKER_URL is set correctly

## Success Criteria

✅ **File Upload Feature is Working When:**
1. Users can upload PDF and TXT files
2. paper.json is created with extracted text
3. Pipeline skips fetch-paper step for uploaded files
4. File validation works (size, type, empty file)
5. User-friendly error messages are shown for invalid files
6. PubMed ID uploads still work normally
7. Video generation completes for uploaded files

## Common Issues & Solutions

| Issue | Solution |
|-------|----------|
| "File is too large" | Use a smaller file (< 50MB) |
| "Unsupported file type" | Use .pdf or .txt file |
| "No text could be extracted" | Try different PDF (image-only PDFs won't work) |
| "paper.json not found" | Check file permissions, disk space |
| Pipeline tries to fetch-paper | Ensure paper.json is in output directory before pipeline starts |
| Celery task doesn't run | Check Redis is running and CELERY_BROKER_URL is set |

---

**Last Updated:** 2025-11-25
**Feature Status:** Ready for Testing
